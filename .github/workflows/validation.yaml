name: Bicep Validation and Deployment

on:
  pull_request:
    paths:
      - '**/*.bicep'
      - '**/*.bicepparam'
  push:
    branches:
      - main

permissions:
  id-token: write      # required for OIDC
  contents: read

jobs:
  # ----------------------------------------------------
  # Step 1: Lint Bicep Files (runs only on pull_request)
  # ----------------------------------------------------
  lint:
    if: github.event_name == 'pull_request'
    uses: AMC-IIOPS/github-workflows/.github/workflows/bicep-lint.yaml@main
    with:
      AZ_LOGIN: true
    secrets:
      # these come from the PR's target environment (repo-level or env-level secrets)
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ----------------------------------------------------
  # Step 2: Detect all modified environments
  # ----------------------------------------------------
  detect-environments:
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      environments: ${{ steps.output_envs.outputs.environments }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Fetch main branch
        run: git fetch origin main

      - name: Determine base commit
        id: set_base_commit
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # for push: compare current HEAD with origin/main
            base_commit=$(git merge-base origin/main HEAD)
          else
            # for pull_request: compare PR base with HEAD
            base_commit="${{ github.event.pull_request.base.sha }}"
          fi

          echo "base_commit=$base_commit" >> "$GITHUB_OUTPUT"

      - name: Detect environments from parameter files
        id: set_envs
        run: |
          base_commit=${{ steps.set_base_commit.outputs.base_commit }}
          echo "Base commit: $base_commit"

          environments='[]'

          # look for changed *.bicepparam files
          for file in $(git diff --name-only "$base_commit" ${{ github.sha }} | grep -E '\.bicepparam$' || true); do
            echo "Detected param file: $file"

            # assume pattern like main.dev.bicepparam / main.stage.bicepparam / etc.
            basename=$(basename "$file")
            env_name="${basename#main.}"
            env_name="${env_name%.bicepparam}"

            environments=$(echo "$environments" | jq --arg env "$env_name" --arg param "$file" \
              '. + [ { "environment": $env, "param_file": $param } ]')
          done

          echo "environments=$environments" > environments.json

      - name: Set environments output
        id: output_envs
        run: |
          echo "environments=$(cat environments.json)" >> "$GITHUB_OUTPUT"

  # ----------------------------------------------------
  # Step 3: Validation (what-if) per environment (PR only)
  # ----------------------------------------------------
  validation:
    if: github.event_name == 'pull_request'
    needs: detect-environments
    runs-on: ubuntu-azure-large
    strategy:
      matrix:
        env_info: ${{ fromJson(needs.detect-environments.outputs.environments) }}
    # IMPORTANT: bind this job to the GitHub Environment (dev/test/stage/prod)
    environment: ${{ matrix.env_info.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Bicep
        run: |
          az config set bicep.use_binary_from_path=false
          az bicep install

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id:      ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:      ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run Bicep what-if
        run: |
          az deployment group what-if \
            --resource-group "${{ vars.RESOURCE_GROUP }}" \
            --template-file ./main.bicep \
            --parameters ./${{ matrix.env_info.param_file }}

  # ----------------------------------------------------
  # Step 4: Deploy to each environment (main branch only)
  # ----------------------------------------------------
  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: detect-environments
    runs-on: ubuntu-azure-large
    strategy:
      matrix:
        env_info: ${{ fromJson(needs.detect-environments.outputs.environments) }}
    # again bind to GitHub Environment
    environment: ${{ matrix.env_info.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Bicep
        run: |
          az config set bicep.use_binary_from_path=false
          az bicep install

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id:      ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:      ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep
        run: |
          echo "Deploying to environment: ${{ matrix.env_info.environment }}"
          az deployment group create \
            --resource-group "${{ vars.RESOURCE_GROUP }}" \
            --template-file ./main.bicep \
            --parameters ./${{ matrix.env_info.param_file }} 
